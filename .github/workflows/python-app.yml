name: NBA Data Sync
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # To daje skryptowi prawo do zapisu
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Playwright
        run: |
          pip install playwright
          playwright install chromium

      - name: Scrape Rotowire
        run: |
          python -c "
          import json, time
          from playwright.sync_api import sync_playwright
          
          def run():
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  page = browser.new_page()
                  try:
                      print('Wchodzę na Rotowire...')
                      page.goto('https://www.rotowire.com/betting/nba/player-props.php', wait_until='networkidle', timeout=60000)
                      time.sleep(5)
                      
                      # Pobieramy dane z zmiennej JavaScript 'data'
                      data = page.evaluate('() => { return (typeof data !== \"undefined\") ? data : []; }')
                      
                      if data and len(data) > 0:
                          with open('nba_data.json', 'w') as f:
                              json.dump(data, f)
                          print(f'Sukces! Pobrano {len(data)} rekordów.')
                      else:
                          print('Błąd: Zmienna data jest pusta lub nie istnieje.')
                  except Exception as e:
                      print(f'Błąd Playwright: {e}')
                  finally:
                      browser.close()
          run()
          "

      - name: Commit and Push
        run: |
          # Sprawdzamy czy plik powstał
          if [ -f nba_data.json ]; then
            git config --global user.name "NBA-Bot"
            git config --global user.email "bot@github.com"
            git add nba_data.json
            git commit -m "Update NBA Data: $(date)" || exit 0
            git push
          else
            echo "Plik nba_data.json nie istnieje - przerywam."
            exit 1
          fi
